From: John Ogness <john.ogness@linutronix.de>
Date: Mon, 30 Nov 2020 01:42:11 +0106
Subject: [PATCH 16/16] printk: kmsg_dump,do_mounts wait for printers
Origin: https://www.kernel.org/pub/linux/kernel/projects/rt/5.10/older/patches-5.10-rt17.tar.xz

Use pr_flush() to give console printers a chance to finish if no
atomic console is available. This should probably be implemented
inside panic(), giving panic() an additional @may_sleep argument.
But that would require evaluating every panic() caller. For now
just call pr_flush() for kmsg_dump and when failing to mount the
root filesystem, since these are both common error paths.

Signed-off-by: John Ogness <john.ogness@linutronix.de>
Signed-off-by: Sebastian Andrzej Siewior <bigeasy@linutronix.de>
---
 init/do_mounts.c       |    1 +
 kernel/printk/printk.c |    6 ++++++
 2 files changed, 7 insertions(+)

--- a/init/do_mounts.c
+++ b/init/do_mounts.c
@@ -457,6 +457,7 @@ void __init mount_block_root(char *name,
 		printk("DEBUG_BLOCK_EXT_DEVT is enabled, you need to specify "
 		       "explicit textual name for \"root=\" boot option.\n");
 #endif
+		pr_flush(true, 1000, true);
 		panic("VFS: Unable to mount root fs on %s", b);
 	}
 	if (!(flags & SB_RDONLY)) {
--- a/kernel/printk/printk.c
+++ b/kernel/printk/printk.c
@@ -3105,6 +3105,12 @@ void kmsg_dump(enum kmsg_dump_reason rea
 			sync_mode = true;
 			pr_info("enabled sync mode\n");
 		}
+
+		/*
+		 * Give the printing threads time to flush, allowing up to 1
+		 * second of no printing forward progress before giving up.
+		 */
+		pr_flush(false, 100, true);
 	}
 
 	rcu_read_lock();
